{% extends "base.html" %}
{% load static %}

{% block title %}Driver Progress{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="cozy-dark-glass p-5 rounded-4 shadow-lg">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-light mb-0">
                <i class="fa-solid fa-chart-line me-2 text-info"></i> Driver Progress
            </h2>
            <a href="{% url 'academy_manager_dashboard' %}" class="btn btn-outline-light btn-sm">
                <i class="fa-solid fa-arrow-left me-2"></i> Back to Dashboard
            </a>
        </div>

        <p class="text-light mb-4">
            Review module progress, scores, and completion history for all registered drivers.
        </p>

        <!-- Filter Bar -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <input id="searchInput" type="text"
                       class="form-control bg-dark text-light border-secondary"
                       placeholder="üîç Filter by driver name..." onkeyup="filterTable()">
            </div>
            <div class="col-md-6">
                <select id="statusFilter" class="form-select bg-dark text-light border-secondary" onchange="filterTable()">
                    <option value="">Filter by status...</option>
                    <option value="completed">Completed</option>
                    <option value="in progress">In Progress</option>
                    <option value="not started">Not Started</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table id="progressTable" class="table table-dark table-striped align-middle mb-0">
                <thead class="table-secondary text-dark">
                    <tr>
                        <th>Driver</th>
                        <th>Module</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Completed At</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in progress %}
                    <tr>
                        <td class="fw-semibold">{{ p.user.get_full_name|default:p.user.username }}</td>
                        <td>{{ p.module.title }}</td>
                        <td>
                            {% if p.score %}
                                <span class="text-info fw-bold">{{ p.score }}%</span>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="status-cell">
                            {% if p.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% elif p.status == 'in_progress' %}
                                <span class="badge bg-warning text-dark">In Progress</span>
                            {% else %}
                                <span class="badge bg-secondary">Not Started</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if p.completed_at %}
                                {{ p.completed_at|date:"d M Y, H:i" }}
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-light-50 py-3">
                            No progress records yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="p-3 mt-4 rounded-3 border border-info bg-dark bg-opacity-75">
            <p class="mb-1 text-info fw-bold">
                ‚ÑπÔ∏è Progress automatically updates when a driver completes lessons or quizzes.
            </p>
            <p class="mb-0 text-info">
                Completed modules are marked green, and scores reflect the driver‚Äôs best attempt.
            </p>
        </div>
    </div>
</div>

<script>
function filterTable() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const statusFilter = document.getElementById("statusFilter").value.toLowerCase();
    const rows = document.querySelectorAll("#progressTable tbody tr");

    rows.forEach(row => {
        const name = row.cells[0].innerText.toLowerCase();
        const status = row.querySelector(".status-cell").innerText.toLowerCase();

        const matchesName = name.includes(searchInput);
        const matchesStatus = !statusFilter || status.includes(statusFilter);

        row.style.display = (matchesName && matchesStatus) ? "" : "none";
    });
}
</script>
{% endblock %}
